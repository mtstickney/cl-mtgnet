(in-package #:mtgnet-sys)

(defun encode-field (field value &optional (encoder #'json:encode-json))
  "Encode VALUE as an object field named FIELD, using ENCODER to
encode VALUE."
  (json:as-object-member (field)
    (funcall encoder value)))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defun serial-slot-p (s)
    (or (symbolp s)
        (and (listp s)
             (destructuring-bind (name field &key (marshall t) &allow-other-keys)
                 s
               (declare (ignore name field))
               marshall))))

  (defun optional-slot-p (s)
    (and (listp s)
         (getf (cddr s) :optional)))

  (defun slot-symbol (s)
    (etypecase s
      (list (destructuring-bind (name &rest r) s
              (declare (ignore r))
              name))))

  (defun slot-key (s)
    (second s))

  (defun slot-marshall-type (s)
    (etypecase s
      (list (getf (cddr s) :marshall-type))))

  (defun cat-symbol (symbol &rest rest)
    (intern (format nil "窿磲疸狎＇簌礅镬钺礤ㄣ镱簌礅镬蝈篝┅┅ㄤ彐躅箪雉镳糸镱犰箪雉豉疱ㄣ桢汶豉疱豉疱簌礅镬戾è镳糸镱犰豉疱镳糸镱犰箪雉箪雉┅ㄥ汜箦豉疱ê黩轸ㄥ汜箦镳糸镱犰豉疱è瑚蜷翦候遽洵黩轸濠舂è候遽铋飑铋飑┅ê蝈徜ㄥ汜箦镳糸镱犰豉疱è候遽候遽洵黩轸濠舂è瑚蜷翦铋飑铋飑┅è铋飑ㄥ汜箦镳糸镱犰豉疱è铋飑舂è候遽瑚蜷翦候遽洵黩轸濠铋飑┅┅┅ㄤ彐轭瀛泔钿轸轱轭鲠扉洵牦镱镡ㄥ蝌矧è豉疱洪铋翎蜱呼疱横沣弩箫镡戥豉疱牦镱洪铋翎蜱宏箫横沣弩箫镡戥牦镱┅ê蝈痫螋灬礅溽ㄣ螬ㄦ矧磲⑸铞犰殇牦镱溽翎骘镡赍泗镦豉疱雍英镡戥豉疱悌镡戥牦镱悌┅┅换韵南栳钿戾疳汶徵弩镱瀹绠豉疱簌礅镬狃痱镳蜷狒屐ㄉы换祜镫轭狒秕喉狎箬犰飙豉疱换韵南渝殒轸痫篌殁戾麸珏铄蜥翦滹泱趄轭珞骘翳弩翳轭珞ㄤ彐磲泸溴骈铄牦镱镡钺礤怙澌怙澌戾舄è箪雉ㄩ篝蜷铉ㄦ轵篝怙澌┅ㄣ潋怙澌怙澌┅箦蜷犰辁邃箪雉蝈盹鲥殒铒＇箦蜷犰箪雉箪雉螬磲脲骢钽ㄣ狒簌礅镬В喉犭瀛钺礤┅ㄢ蹰熹骢钽ㄣ狒簌礅镬В衡蹰熹钺礤┅躅磲蝮栳祆骢钽ㄣ狒簌礅镬В乎铐狎箬犰飙钺礤┅磲蝮栳祆骢钽ㄣ狒簌礅镬В喉狎箬犰飙钺礤┅啜痱镧ㄤ彐篝蝓泗钺礤换橡糸镱犰滹泱趄轭括殒篝蜷铉ㄦ轵篝怙澌┅扉篝ㄦ轵篝怙澌┅铋飑换屿雉扉篝括祜镳骘箪雉轭箪雉泔祆邈ㄥ豉疱汜箦箪雉扉篝ㄤ弩趄蹉趱蜷铉忾钿钺礤骈屐蝈篝脲黠蜾疳轵脲轭轸獒豉疱铋豉疱皓蝈徜镱禊铋蝈徜镱禊皓犰祜鳝雉桢颦脲螬箪雉ㄤ邈灬蝈ㄩ珙矧骈屐洎啜钺礤轭轸獒括殒豉疱啜呼疱豉疱铋飑括殒蝈徜镱禊啜候遽洵镱禊蝈徜镱禊┅┅┅┅换序镤蹉篝蝓泗躜骝镯溴泔溴牦镱镡赍泗ㄤ彐躅怩殪洵骢钽牦镱镡戛戾è狎珈轶Ж┅括祜镳骘轭箦蜷犰辁邃箪雉泔祆邈啜戾è沐祆ㄡ篌镢箪雉脲螬牦镱镡呼弩＇羼踽祓┅括躅戾篌箪雉镳糸镱犰候遽洎啜躅戾篌沐祆ㄥ蝌矧ч铞犰殇牦镱镡呼疱К钺礤宏箫牦镱镡戛┅麒孱沐祆箦翩ㄧ弭狎珈轶ㄩ铘弪簌礅镬钺礤箪雉簌礅镬螬щ妁黠蜾┅ㄩ箪雉磲蝮栳祆豉疱螬痱镧啜ㄣ狒簌礅镬В衡蹰熹箪雉磲蝮栳祆豉疱螬ㄣ潋沐祆┅啜沅沐祆┅┅┅ㄡ痧禊＇磲脲骢钽狎珈轶舂┅ㄤ彐躅躅磲蝮栳祆骢钽牦镱篝蜷铉戾è牦镱镡戾è牦镱邯牦镱殇孱糸骈弪钺礤麸扉箴＇殇孱糸豉牦镱邯殇孱糸骈弪钺礤麸脲＇殇孱糸豉┅牦镱轰邈镤瀛牦镱骝镯篝蜷铉牦镱篝蜷铉┅┅ì怩殪洵骢钽牦镱镡戛┅ㄤ彐躅磲蝮栳祆骢钽镡戛牦镱瑚轸璀镡赍泗ī括骒弭è徙沐篌矧ㄦ殄熹ㄣ狒簌礅镬钺礤В涵骈屐洎┅祜镳骘轭箦蜷犰辁邃箪雉泔祆邈戾è孱泔溴骘蝽啜孱泔溴骈屐箪雉脲螬ìㄡ沣弩箫箪雉簌礅镬螬镡戛括殒箪雉磲蝮栳祆豉疱螬扉篝啵Кㄣ狒簌礅镬В喉狎箬犰飙箪雉磲蝮栳祆豉疱螬┅Ж┅┅ㄩ箪雉镳糸镱犰瑚蜷翦啜麒孱ìㄡ沣弩箫箪雉簌礅镬螬镡戛孱泔溴骘蝽孱泔溴骘蝽┅┅┅┅换韵南溴犰鏖翳翳麒镬孱泔溴翳轭黹玷麽铘栳鲥换磲蝮栳祆轭豉疱箦骘狎珞蜥翳弪翳犷溴泔溴蝮箫麇汜换泔铘蝻孱泔溟铉麸锂烷玷犰箫麽铘麸篦轸汨麸蝈犰豉疱犷换躞礤翳镤轭篝遽镦翳轶簌礅镬泔钽狒孱狒轱怩箝铄篌ㄤ彐躅磲蝮栳祆狎绛扉篝ㄡ蜱螬ㄣ桢汶豉疱狎珞扉篝牦镱瑚轸璀狎蜥ī磲疸灬礅溽雯牦镱横蟓狎蜥礤礅弪īㄦ躅汜祆溴驷蹯舡孱泔溴颡雯┅狎珞┅ㄤ彐躅怩殪洵狎绛扉篝扉篝扉篝ㄤ彐轭瀛牦镱镡蝠悱汜祆⒘箝铉戾礤翳镤轭鲲汜糸镱箦蝣殂Ⅲ弪鲩沐洪铋糸犰呼疱篝蜷铉候遽洵镱禊舂礤翳镤㈨弭栾洧洪铋糸犰呼疱篝蜷铉候遽洵镱禊舂ㄡ蜱⑨蜱螈洪铋糸犰Ж呼疱扉篝候遽洵镱禊喉狎箬犰飙豉疱狎绛扉篝ㄩ㈤洧洪铋糸犰铋猴痿轱钺候遽候遽洵镱禊舂ㄤ彐轭瀛牦镱镡蝠悱弪蝻⑴蝌矧镡赍泗泔铘衢铄轭驷殪邃蝠悱蝈篚祠礤篌徵㈨弩筢珏洪铋糸犰呼疱篝蜷铉候遽洵镱禊舂ㄣ镤泔溴洪铋糸犰候遽洵镱禊舂ㄤ狒溽翎洪铋糸犰铋候遽洵镱禊猴痿轱钺候遽洵黩轸濠ㄤ彐轭瀛牦镱镡蝠悱蝈篚祠⒃桢蝈篚祠镦犷倚礤翳镤轭鲲汜糸镱ㄤ狒溽翎洪铋糸犰铋猴痿轱钺候遽洵黩轸候遽洵镱禊舂ㄥ蝌矧㈠蝌矧洪铋糸犰铋猴痿轱钺候遽洵黩轸候遽洵镱禊喉狎箬犰飙豉疱蝠悱弪蝻颟麽蝾轭珞Ⅶ狎铋铉螈洪铋糸犰Ж猴痿轱钺候遽洵黩轸候遽洵镱禊喉狎箬犰飙豉疱蝠悱麽蝾轭绛扉篝ㄩ㈤洧洪铘轸獒铋猴痿轱钺候遽洵黩轸候遽洵镱禊舂ㄤ彐磲泸溴骈铄镡赍泗狎蜥钺礤豉疱戾舄è痱邃殂狒瀛钺礤ㄣ狒簌礅镬钺礤В涵皓镡戥痱邃殂狒瀛钺礤ㄣ狒簌礅镬豉疱В涵皓┅啜痱镧ㄤ彐躅痱邃殂狒瀛钺礤翳轭绌ㄡ钿扉篝翳轭绌ㄥ鲥蝙＇镡戥痱邃殂狒瀛钺礤翳轭绌┅ㄤ彐豉疱钺礤īЖ筢糸箧殄痱邃殂狒瀛钺礤┅ㄤ彐躅ㄣ狒簌礅镬В喉狎箬犰飙钺礤镡戛ㄣ桢汶豉疱镡钺礤牦镱瑚轸璀狎蜥ī磲疸灬礅溽铹牦镱横蟓狎蜥礤礅弪īìㄣ狒簌礅镬В喉狎箬犰飙豉疱铹┅镡戛┅ㄤ彐躅ㄣ狒簌礅镬В衡蹰熹钺礤镡戛ㄣ桢汶豉疱镡扉篝磲疸狎＇ㄣ狒簌礅镬В衡蹰熹豉疱镡戛ㄤ彐躅ㄣ狒簌礅镬В乎铐狎箬犰飙钺礤篝颟ㄣ桢汶豉疱篝篝蜷铉戾舄è牦镱邯殇孱糸骈弪钺礤麸脲＇殇孱糸豉牦镱邯牦镱殇孱糸骈弪钺礤麸扉箴＇殇孱糸豉镡牦镱轰邈镤瀛牦镱骝镯篝蜷铉篝颟┅ìㄣ狒簌礅镬В衡蹰熹钺礤镡戛┅┅ㄤ彐轭瀛镡赍泗狎蜥蝠悱蝈聃弩蝠悱汜祆ㄤ彐轭瀛镡赍泗狎蜥蝠悱蝈箴镱箦蝠悱蝈篚祠ㄤ彐轭瀛镡赍泗狎蜥蝠悱麽蝾轭绛扉篝蝠悱弪蝻颟