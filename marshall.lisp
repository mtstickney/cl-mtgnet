(in-package #:cl-mtgnet)

(defun encode-field (field value &optional (encoder #'json:encode-json))
  "Encode VALUE as an object field named FIELD, using ENCODER to
encode VALUE."
  (json:as-object-member (field)
    (funcall encoder value)))

(defun serial-slot-p (s)
  "Return T if S is a definition for a serialized slot, or NIL otherwise."
  (or (symbolp s)
      (and (listp s)
           (getf s :marshall t))))

(defun optional-slot-p (s)
  "Return the optional type keyword for the slot-definition
S (:read, :write, or :both), or NIL if S is not an optional slot."
  (and (listp s)
       (getf s :optional nil)))

(defun slot-optional-type (slot type)
  (check-type slot (or list symbol))
  (check-type type keyword)
  (and (listp slot)
       (let ((slot-type (optional-slot-p slot)))
         (ecase type
           (:write
            (or (eq slot-type :write)
                (eq slot-type :both)))
           (:read
            (or (eq slot-type :read)
                (eq slot-type :both)))
           (:both (eq slot-type :both))))))

(defun slot-symbol (slot)
  (if (symbolp slot)
      slot
      (car slot)))

(defun cat-symbol (symbol &rest rest)
  (intern (format nil "窿磲疸狎＇簌礅镬钺礤ㄣ镱簌礅镬蝈篝┅┅换韵南渝殒轸痫篌殁戾麸轭沆蹁滹泱趄轭珞骘翳弩翳轭珞ㄤ彐磲泸溴骈铄牦镱镡钺礤怙澌怙澌戾舄è箪雉ㄩ篝蜷铉ㄦ轵篝怙澌┅ㄦ轵篝ㄣ潋怙澌┅ㄦ轵篝怙澌┅箦蜷犰辁邃箪雉蝈盹鲥殒铒＇箦蜷犰箪雉箪雉螬篝蝓泗镳趔ㄩ篝蜷铉ㄦ轵篝怙澌┅铘桡潋怙澌铘桡潋怙澌┅ㄤ彐狨祠轭轸狎珞戾è沐祆ㄡ篌镢轰彐狨祠轭轸狎珞篝蝓泗镳趔┅ㄩ沐祆ㄣ潋沐祆铋飑┅磲脲骢钽ㄣ狒簌礅镬В喉犭瀛钺礤┅ㄣ麸ㄣ狒簌礅镬В邯磲脲骢钽┅ㄢ蹰熹骢钽ㄣ狒簌礅镬В衡蹰熹钺礤┅躅磲蝮栳祆骢钽ㄣ狒簌礅镬В乎铐狎箬犰飙钺礤┅磲蝮栳祆骢钽ㄣ狒簌礅镬В喉狎箬犰飙钺礤┅啜痱镧ㄤ彐篝蝓泗ì钺礤ê泔铙趄蹉麸泗矧┅换橡糸镱犰滹泱趄轭括殒篝蜷铉ㄦ轵篝怙澌┅扉篝ㄦ轵篝怙澌┅铋飑换屿雉扉篝括祜镳骘箪雉轭箪雉泔祆邈ㄥ豉疱汜箦箪雉簌礅镬箪雉扉篝ㄤ弩趄蹉趱蜷铉忾钿钺礤蝈篝脲黠蜾疳轵脲轭轸獒犰祜鳝雉桢颦脲螬箪雉啜钺礤轭轸獒横祆秣雉桢颦脲离妁黠蜾疳轵螬┅┅换序镤蹉篝蝓泗躜骝镯溴泔溴牦镱镡赍泗ㄤ彐躅怩殪洵骢钽牦镱镡戛戾è狎珈轶Ж┅括祜镳骘轭箦蜷犰辁邃箪雉泔祆邈啜戾è沐祆ㄡ篌镢牦镱脲К螬牦镱镡戛┅括躅戾篌箪雉镳糸镱犰豉疱候遽洎啜躅戾篌沐祆ㄥ蝌矧ч铞犰殇牦镱镡呼疱К钺礤宏箫牦镱镡戛┅麒孱沐祆箦翩ㄧ弭狎珈轶ㄩ铘弪簌礅镬钺礤螬щ妁黠蜾┅ㄣ潋沐祆┅┅ㄡ痧禊＇磲脲骢钽狎珈轶舂┅ㄤ彐躅躅磲蝮栳祆骢钽牦镱篝蜷铉戾è牦镱镡牦镱轰邈镤瀛牦镱骝镯篝蜷铉牦镱篝蜷铉┅ì怩殪洵骢钽牦镱镡戛┅ㄤ彐躅磲蝮栳祆骢钽镡戛牦镱瑚轸璀镡赍泗ī括骒弭è徙沐篌矧ㄦ殄熹ㄣ狒簌礅镬钺礤В涵骈屐洎┅祜镳骘轭箦蜷犰辁邃箪雉泔祆邈戾è孱泔溴骘蝽啜孱泔溴骈屐Кìㄡ沣弩箫螬镡戛┅ㄩ箪雉镳糸镱犰豉疱瑚蜷翦啜麒孱ìㄡ沣弩箫螬镡戛孱泔溴骘蝽孱泔溴骘蝽┅┅┅ㄤ彐躅磲脲骢钽é蝈篝轭轸狎珞换砒痨殂轸禊溴骈铄镳糸镱翎脲痱邈邃孱沐雉桢蝼轶躞轰彐狨祠轭轸狎珞戾è轭轸狎珞ㄣ镱汜翦钺翦ъ轶轭轸狎珞ㄣ潋溴驷蹯舡轭轸狎珞┅┅ㄡ痧禊＇泗矧轭轸狎珞┅┅┅ㄤ彐轭瀛牦镱镡蝠悱汜祆⒘箝铉戾礤翳镤轭鲲汜糸镱è箦蝣殂洪铋糸犰呼疱篝蜷铉候遽洵镱禊舂礤翳镤洪铋糸犰呼疱篝蜷铉候遽洵镱禊舂ㄡ蜱洪铋糸犰Ж呼疱狎珈轶候遽洵镱禊舂ㄩ洪铋糸犰铋候遽洵镱禊舂┅ㄤ彐轭瀛牦镱镡蝠悱蝈篚祠⒘箝铉戾蝈篚祠骝镯礤翳镤轭鲲汜糸镱è溽翎洪铋糸犰Ж呼疱泔铙候遽洵镱禊喉狎箬犰铋飑麽蝾轭珞洪铋糸犰Ж呼疱扉篝候遽洵镱禊舂ㄥ钽镤弪洪铘殚犰＇牦镱哄钽镤瀛牦镱呼疱骢钽糸镱喉狎箬犰铋飑ㄩ猴痿轱钺衡雉瑭ê溴驷蹯舡轭轸狎珞轰狒ㄤ彐篝蝓泗蝠悱蝈篚祠⒘箝铉戾蝈篚祠骝镯礤翳镤轭鲲汜糸镱换彘翳弪ê牧粤溽翎矧ê乓蚁弪蝻颦镡戛ㄤ狒Ж呼疱泔铙麽蝾轭珞Ж呼疱扉篝ㄥ钽镤弪＇牦镱哄钽镤瀛牦镱呼疱骢钽糸镱ㄩ洎ㄤ彐磲泸孱泔溴骈屐潴è镡戛蝈篝骈屐潴⑹酉苇孱泔溴翳粕盘挠箪雉镦下十砒疱泗麸忮蝓轭箝溴视衔鹤稍拳下逝迷忪镢氘戾è镡戥鲠ㄧ孱簌愆┅啜戾è镡戥鲠镡戛痱镧括祜镳骘轭骈屐潴泔祆邈ㄩ扉篝姗啜孱泔溴骈屐聃雉ㄦ轵篝姗箪雉鲠祯镡戥鲠聃雉ㄦ轵篝姗┅箦泔钿姗啜孱泔溴骈屐聃雉姗箪雉鲠祯镡戥鲠聃雉姗┅┅┅┅ㄤ彐躅牦镱脲簌礅⒁弭躜翳簌礅镬痱镤蹉邃怡视衔孱泔溟铉犷溴泔溟铉淤吐ㄦ躅汜祆牦镱汉殇孱糸骈弪钺礤麸脲牦镱轰邈镤瀛牦镱骝镯篝蜷铉ㄦ躅汜祆牦镱汉牦镱殇孱糸骈弪钺礤麸扉箴牦镱哄钽镤瀛牦镱麸篝蜷铉簌礅┅┅ㄤ彐磲泸栳蟓骈屐潴ㄡ扉篝蝈篝骈屐潴⒂遽蜚骘犰翳粕盘挠轭翳视衔溴泔溴镡赍泗撂捎援砒疳钿邃泔溴蝈趱蝾殒犰骈屐潴麇蝈骘躅洮紊雉桢蝼轶瀹啜犷括祜镳骘轭骈屐潴泔祆邈啜狍箫牦镱脲聃雉姗犰轶舂┅ㄤ彐躅珏舡骈屐脲犰轶蝈篝狎珞⒁弭躜彘翳弪翳鲠祯镦翳骈屐钺礤伺骝镯翳溴泔溴牦镱镡赍泗撂捎袁矧紊坍龄溟糸镱犰狎珲礤铘鏖祆忮疳篌邃麸劣酉卯戾舄è脲牦镱脲脲┅ㄣ屐ㄡ痧禊＇狍箫ㄣ镱脲ㄣ镱犰轶狎珞┅┅ㄡ钿沐祆ㄣ潋沐祆┅┅换膨蝻泔钿轸轱铙ㄤ彐轭瀛泔钿轸轱轭鲠扉洵牦镱镡īè豉疱洪铋翎蜱呼疱牦镱洪铋翎蜱宏箫瞟┅ㄤ彐轭瀛泔钿轸轱轭鲠扉洵汜祆镡赍泗īè镡洪铋翎蜱猴怅┅ㄤ彐轭瀛泔钿轸轱轭鲠扉洵蝈篚祠镡īè镡洪铋翎蜱猴怅┅换冕祆镡赍泗镱疱礤翳镤汜祆换韵南崎钿盹蝈篝蜷铉孱溴骈铋糸镱骘狎珈轶ě扉篝篝蜷铉┛ㄤ彐豉疱狎珈轶ī囔轶舂ㄤ彐篝蝓泗蝠悱汜祆⒘箝铉戾礤翳镤轭鲲汜糸镱箦蝣殂呼疱篝蜷铉候遽洵镱禊舂礤翳镤呼疱篝蜷铉候遽洵镱禊舂ㄡ蜱Ж呼疱狎珈轶候遽洵镱禊舂ㄩ铋候遽洵镱禊舂ㄤ彐躅鲠扉洵汜祆镡戛⒁弭躜铙殒翳镡赍泗轶鲠扉昧烫镡赍泗蝠悱汜祆镡戛ㄤ彐躅磲蝮栳祆汜祆镡戛⑼狎箬犰翳汜祆镡赍泗下麸视衔ㄣ桢汶豉疱镡蝠悱汜祆牦镱瑚轸璀镡赍泗īㄥ钽镤瀛骈屐潴镡戛箦蝣殂礤翳镤狎珞殇┅ㄤ彐躅磲蝮栳祆汜祆镡戛ㄣ桢汶豉疱镡蝠悱汜祆镳糸磲喉狒汨镡è篝蝓泗躜蝠悱汜祆箦蝣殂礤翳镤狎珞殇祜镳骘轭Ж箦蝣殂礤翳镤狎珞殇滹ㄥ钽镤瀛骈屐簌礅镬鲠祯姗┅ㄟㄥ蝌矧⒄铄疱泗邃倚铆昧烫篝蝓泗躜澧┅┅ㄤ彐躅怩殪洵汜祆牦镱镡戛⒙蹰熹犷倚铆昧烫镡赍泗骝镯翳视衔下溽翎麒孱铒ㄨ狍骈屐潴牦镱镡箦蝣殂礤翳镤狎珞┅ㄥ蝌矧ч铞犰殇牦镱镡呼疱蝠悱汜祆宏箫牦镱镡戛磲脲蝠悱汜祆后弪鲩沐ㄧ弭骈屐箦蝣殂牦镱镡戛喉弭栾ㄧ弭骈屐ы弭栾牦镱镡戛横蜱ㄧ弭骈屐п蜱牦镱镡戛洪ㄧ弭骈屐ч牦镱镡戛┅ㄤ彐躅怩殪洵汜祆牦镱镡戛镳糸磲喉狒汨牦镱镡è犰轶è牦镱脲箦蝣殂濠箦蝣殂濠è牦镱脲ы弭栾洎礤翳镤è牦镱脲п蜱螬狎珞┅磲脲蝠悱汜祆后弪鲩沐箦蝣殂喉弭栾礤翳镤横蜱狎珞洪镳糸磲喉狒汨牦镱镡è镳糸磲汉狍箫牦镱脲ч洎殇殇┅洪ㄧ弭骈屐ч牦镱镡戛┅换镳糸磲汉殒磲翥换镳糸磲汉狍箫牦镱脲ч洎殇牦镱镡换殇换铋飑┅ㄟㄥ蝌矧ч铞犰殇牦镱镡呼疱蝠悱汜祆宏箫牦镱镡戛┅ㄤ彐躅躅磲蝮栳祆汜祆牦镱篝蜷铉⒄铐狎箬犰昧烫镡赍泗骝镯翳溴泔溴视衔釉疑吻戾è牦镱镡牦镱轰邈镤瀛牦镱骝镯篝蜷铉牦镱篝蜷铉┅ㄢ蹰熹汜祆牦镱镡戛┅换义篚祠镡赍泗镱疱铒瞽铒糸骈汜糸镱礤翳镤汜祆ㄤ彐篝蝓泗蝠悱蝈篚祠⒘箝铉戾蝈篚祠骝镯礤翳镤轭鲲汜糸镱换彘翳弪ê牧粤溽翎矧ê乓蚁弪蝻颦镡戛ㄤ狒Ж呼疱泔铙麽蝾轭珞Ж呼疱扉篝ㄥ钽镤弪＇牦镱哄钽镤瀛牦镱呼疱骢钽糸镱ㄩ洎ㄤ彐躅磲蝮栳祆蝈篚祠镡戛镳糸磲喉狒汨镡è篝蝓泗躜蝠悱蝈篚祠溽翎麽蝾轭珞殇祜镳骘轭Ж溽翎麽蝾轭珞殇滹ㄥ钽镤瀛骈屐簌礅镬鲠祯姗┅戾脲鲠飑镳糸磲喉狒汨溽翎è泔铙轰狒溽翎箦翩脲т狒鲠溽翎┅è泔铙哄蝌矧弪蝻颟箦翩脲у蝌矧鲠弪蝻颟ㄟㄥ蝌矧⒁忻遗诱淘牧粤轶铄轸桢ê牧粤溽翎铒ê乓蚁弪蝻颟┅ㄥ钽镤瀛骈屐脲鲠飑┅ㄟㄥ蝌矧⒄铄疱泗邃倚铆遗诱淘篝蝓泗躜澧┅┅ㄤ彐躅磲蝮栳祆蝈篚祠镡戛⑼狎箬犰翳遗诱淘镡赍泗下麸视衔戾è蝈篚祠溽翎蝠悱蝈篚祠溽翎镡戛┅麒孱矧铒蝈篚祠溽翎铒ㄣ镱箴蝈篚祠溽翎┅铒礤礅弪ㄣ狎蝈篚祠溽翎Ж轰狒哄蝌矧┅ㄡ钿ㄥ耢ㄣ狎蝈篚祠溽翎哄蝌矧铛祆ㄣ潋蝈篚祠溽翎┅┅ㄥ蝌矧ч铞犰殇蝈篚祠镡猴怅镡戛牦镱瑚轸璀镡赍泗īㄥ钽镤瀛骈屐潴镡戛麽蝾轭珞殇ㄩㄥ耢ㄣ狎蝈篚祠溽翎哄蝌矧ㄥ钽镤瀛骈屐у蝌矧ㄣ潋蝈篚祠溽翎┅ㄥ钽镤瀛骈屐т狒ㄣ潋蝈篚祠溽翎蝠悱蝈篚祠孱泔溴镡戛┅┅ㄤ彐躅怩殪洵蝈篚祠牦镱镡戛镳糸磲喉狒汨牦镱镡è犰轶è牦镱脲麽蝾轭珞麽蝾轭珞┅ㄤ彐躅怩殪洵蝈篚祠牦镱镡戛⒙蹰熹犷倚铆遗诱淘镡赍泗骝镯翳视衔下溽翎戾舄è蝈篚祠弪蝻ㄧ弭骈屐у蝌矧牦镱镡戛蝈篚祠溽翎ㄩ蝈篚祠弪蝻ㄣ镱哄蝌矧蝈篚祠弪蝻颟ㄣ镱轰狒ㄧ弭骈屐т狒牦镱镡戛┅┅麒孱铒ㄨ狍骈屐潴牦镱镡殇┅ㄥ蝌矧ч铞犰殇牦镱镡猴怅牦镱镡戛麒孱ㄡ钿铒ㄨ狍骈屐潴牦镱镡溽翎┅铒ㄨ狍骈屐潴牦镱镡弪蝻颟┅麽蝾⑹箫镡栳铄轸桢耗猎铒号乙弦骈屐洮狍篚黹铉ê牧粤紊泰牦镱镡戛磲脲蝠悱蝈篚祠洪ㄧ弭骈屐ч牦镱镡戛瑚狎铋铉ㄧ弭骈屐麽蝾轭珞牦镱镡戛轰狒蝈篚祠溽翎┅ㄤ彐躅躅磲蝮栳祆蝈篚祠牦镱篝蜷铉⒄铐狎箬犰遗诱淘镡赍泗骝镯翳溴泔溴视衔釉疑吻戾舄è牦镱镡牦镱轰邈镤瀛牦镱骝镯篝蜷铉牦镱篝蜷铉┅ㄢ蹰熹蝈篚祠牦镱镡戛┅换义聃弩衄扉篝镦昧烫ㄤ彐躅蝠悱蝈聃弩舡镡戛⒁弭躜殒下轶遗颜庞镡赍泗紊雉桢蝼轶瀹ㄡ钿扉篝镡戛ㄥ鲥蝙＇蝠悱汜祆镡戛┅ㄤ彐豉疱蝠悱蝈聃弩īЖ筢糸箧殄蝠悱蝈聃弩舡皓ㄤ彐躅磲蝮栳祆蝈聃弩镡戛ㄣ桢汶豉疱镡蝠悱蝈聃弩舂牦镱瑚轸璀狎蜥ī祜镳骘汜祆轭镡滹牦镱横蟓狎蜥礤礅弪ī磲蝮栳祆汜祆汜祆┅┅ㄤ彐躅躅磲蜩筢祆蝈聃弩牦镱篝蜷铉⒄铐狎箬犰遗颜庞镡赍泗骝镯翳溴泔溴视衔镡赍泗视衔下十戾è牦镱镡牦镱轰邈镤瀛牦镱骝镯篝蜷铉牦镱篝蜷铉┅躅戾篌扉篝牦镱镡戛ㄥ蝌矧ч铞犰殇牦镱镡呼疱蝠悱蝈聃弩宏箫牦镱镡戛磲疸狎＇怩殪洵汜祆牦镱镡戛┅换义箴镱箦扉篝镦遗诱淘ㄤ彐躅蝠悱蝈箴镱箦镡戛⒁弭躜殒下轶遗有衔优镡赍泗紊雉桢蝼轶瀹ㄡ钿扉篝镡戛ㄥ鲥蝙＇蝠悱蝈篚祠镡戛┅ㄤ彐豉疱蝠悱蝈箴镱箦īЖ犷扉篝筢糸箧殄蝈箴镱箦皓┅换韵南狍泔铞孱殄铘狍翳轶轶轸箦屙扉脲磲蝮栳祆箬秕熹换蝈趱蝾篝蜷铉蜥翳弪翳犷黩轸轭麸牦镱邯牦镱秕麴豸ㄤ彐躅磲蝮栳祆蝈箴镱箦镡戛⑼狎箬犰翳倚铆遗有衔优镡赍泗下麸视衔ㄣ桢汶豉疱镡蝠悱蝈箴镱箦牦镱瑚轸璀狎蜥ī祜镳骘蝈篚祠轭镡滹牦镱横蟓狎蜥礤礅弪ī磲蝮栳祆蝈篚祠蝈篚祠┅┅ㄤ彐躅躅磲蝮栳祆蝈箴镱箦牦镱篝蜷铉⒄铐狎箬犰遗有衔优镡赍泗骝镯翳溴泔溴视衔镡赍泗视衔釉疑吻戾è牦镱镡牦镱轰邈镤瀛牦镱骝镯篝蜷铉牦镱篝蜷铉┅躅戾篌扉篝牦镱镡戛ㄥ蝌矧ч铞犰殇牦镱镡呼疱蝠悱蝈箴镱箦宏箫牦镱镡戛磲疸狎＇怩殪洵蝈篚祠牦镱镡戛┅